name: üî• AWS Resource Nuke

on:
  workflow_dispatch:

jobs:
  nuke:
    runs-on: ubuntu-latest
    name: Force Delete AWS Resources

    steps:
    - name: üõ°Ô∏è Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-1  # üîÅ CHANGE THIS TO YOUR ACTUAL REGION

    - name: üîç List All Relevant Resources
      run: |
        echo "üîé Checking current resources..."
        aws ecr describe-repositories --output table || echo "No ECR repos"
        aws elbv2 describe-target-groups --output table || echo "No Target Groups"
        aws logs describe-log-groups --output table | grep medusa || true
        aws iam get-role --role-name ecsTaskExecutionRole || echo "No such IAM Role"
        aws rds describe-db-subnet-groups --output table | grep medusa || true

    - name: üí£ Nuke Resources
      run: |
        echo "üí£ Starting resource deletion..."

        # Delete ECR Repo
        aws ecr delete-repository --repository-name medusa-ecr-repo --force || echo "‚ùå ECR not found"

        # Delete Target Group
        TG_ARN=$(aws elbv2 describe-target-groups --names medusa-tg --query "TargetGroups[0].TargetGroupArn" --output text 2>/dev/null)
        if [[ "$TG_ARN" != "None" && "$TG_ARN" != "" ]]; then
          echo "Deleting Target Group $TG_ARN"
          aws elbv2 delete-target-group --target-group-arn "$TG_ARN"
        else
          echo "‚ùå Target Group not found"
        fi

        # Delete CloudWatch Log Group
        aws logs delete-log-group --log-group-name /ecs/medusa || echo "‚ùå Log group not found"

        # Delete IAM Role
        POLICIES=$(aws iam list-attached-role-policies --role-name ecsTaskExecutionRole --query "AttachedPolicies[*].PolicyArn" --output text 2>/dev/null)
        for POLICY in $POLICIES; do
          aws iam detach-role-policy --role-name ecsTaskExecutionRole --policy-arn $POLICY
        done
        aws iam delete-role --role-name ecsTaskExecutionRole || echo "‚ùå IAM Role not found"

        # Delete RDS DB Subnet Group
        aws rds delete-db-subnet-group --db-subnet-group-name medusa-db-subnet-group || echo "‚ùå DB Subnet Group not found"

        echo "‚úÖ All deletions attempted."
