name: Deploy Medusa ECS

on:
  push:
    branches:
      - main

jobs:
  cleanup:
    name: 🧹 Clean Existing AWS Resources
    runs-on: ubuntu-latest
    steps:
      - name: 🛡️ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1  # or your region

      - name: 🔍 Get Target Group ARN
        id: get_tg
        run: |
          arn=$(aws elbv2 describe-target-groups --names medusa-tg --query "TargetGroups[0].TargetGroupArn" --output text || echo "")
          echo "tg_arn=$arn" >> $GITHUB_OUTPUT

      - name: 🧹 Delete AWS Resources
        run: |
          # Delete ECR Repo
          aws ecr delete-repository --repository-name medusa-ecr-repo --force || echo "ECR repo not found"

          # Delete Target Group
          if [ "${{ steps.get_tg.outputs.tg_arn }}" != "" ]; then
            aws elbv2 delete-target-group --target-group-arn "${{ steps.get_tg.outputs.tg_arn }}"
          else
            echo "Target group not found"
          fi

          # Delete IAM Role
          aws iam delete-role --role-name ecsTaskExecutionRole || echo "IAM role not found"

          # Delete CloudWatch Log Group
          aws logs delete-log-group --log-group-name /ecs/medusa || echo "Log group not found"

          # Delete RDS Subnet Group
          aws rds delete-db-sub
